jobs:
  ~chart: jobs
  runs:
    build-api:
      use: build
      with:
        imagePackage: api
        dockerfile: api/Dockerfile
    build-web:
      use: build
      with:
        imagePackage: web
        dockerfile: web/Dockerfile

api:
  ~chart: app
  ~needs: [build-api]
  imagePackage: api
  probesPath: /api/v1/health
  livenessProbe:
    failureThreshold: 15
    httpGet:
      path: /api/v1/health
      port: http
      scheme: HTTP
    initialDelaySeconds: 30 # Délai avant la première vérification après le démarrage du pod
    periodSeconds: 10 # Fréquence des vérifications
    successThreshold: 1
    timeoutSeconds: 10 # Temps maximum pour que l'endpoint réponde
  containerSecurityContext:
    readOnlyRootFilesystem: true
  envFrom:
    - configMapRef:
        name: www-configmap
    - secretRef:
        name: www-secret
  resources:
    limits:
      cpu: 400m
      memory: 1024Mi
    requests:
      cpu: 200m
      memory: 512Mi
  annotations:
    oblik.socialgouv.io/min-request-cpu: 200m
    oblik.socialgouv.io/min-request-memory: 512Mi
    oblik.socialgouv.io/min-limit-cpu: 400m
    oblik.socialgouv.io/min-limit-memory: 1024Mi
  volumes:
    - name: tmp
      emptyDir: {}
    - name: cache
      emptyDir: {}
    - name: home
      emptyDir: {}
  volumeMounts:
    - mountPath: /app/tmp
      name: tmp
    - mountPath: /app/cache
      name: cache
    - mountPath: /app/home
      name: home

web:
  ~chart: app
  ~needs: [build-web]
  imagePackage: web
  probesPath: /api/health
  livenessProbe:
    failureThreshold: 15
    httpGet:
      path: /api/health/
      port: http
      scheme: HTTP
    initialDelaySeconds: 30 # Délai avant la première vérification après le démarrage du pod
    periodSeconds: 10 # Fréquence des vérifications
    successThreshold: 1
    timeoutSeconds: 10 # Temps maximum pour que l'endpoint réponde
  containerSecurityContext:
    readOnlyRootFilesystem: true
  resources:
    limits:
      cpu: 400m
      memory: 1024Mi
    requests:
      cpu: 400m
      memory: 512Mi
  annotations:
    oblik.socialgouv.io/min-request-cpu: 400m
    oblik.socialgouv.io/min-request-memory: 512Mi
    oblik.socialgouv.io/min-limit-cpu: 400m
    oblik.socialgouv.io/min-limit-memory: 1024Mi
  volumes:
    - name: tmp
      emptyDir: {}
    - name: next
      emptyDir: {}
  volumeMounts:
    - mountPath: /tmp
      name: tmp
    - mountPath: /app/.next
      name: next
  initContainers:
    - name: copy-next
      image: "{{ .Values.global.registry }}/{{ .Values.global.projectName }}/{{
        .Values.global.imageRepository }}/app:{{ .Values.global.imageTag }}"
      command: ["/bin/sh", "-c"]
      args:
        - cp -r /app/.next/* /mnt/next;
      volumeMounts:
        - name: next
          mountPath: /mnt/next
