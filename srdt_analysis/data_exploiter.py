import json

from srdt_analysis.albert import AlbertBase
from srdt_analysis.chunker import Chunker
from srdt_analysis.collections import Collections
from srdt_analysis.constants import BASE_URL_CDTN, MODEL_VECTORISATION
from srdt_analysis.logger import Logger
from srdt_analysis.models import (
    XML_AS_JSON,
    ChunkerContentType,
    CollectionName,
    Document,
    DocumentData,
    DocumentsList,
    FormattedTextContent,
    ResultProcessDocumentType,
)


class BaseDataExploiter:
    def __init__(self):
        self.chunker = Chunker()
        self.collections = Collections()
        self.albert = AlbertBase()
        self.logger = Logger("BaseDataExploiter")

    def get_content(self, _doc: Document) -> FormattedTextContent:
        raise NotImplementedError("Subclasses should implement this method")

    def process_documents(
        self,
        data: DocumentsList,
        collection_name: CollectionName,
        chunker_content_type: ChunkerContentType,
    ) -> ResultProcessDocumentType:
        results: list[DocumentData] = []
        self.logger.info(f"Number of articles to be processed: {len(data)}")

        for doc in data:
            content = self.get_content(doc)

            chunks = self.chunker.split(content, chunker_content_type)

            doc_data = self.create_document_data(doc, content, chunks)
            results.append(doc_data)

        id = self.collections.create(collection_name, MODEL_VECTORISATION)
        self.logger.info(
            f"Uploading {len(results)} documents from {collection_name} in collection_id {id}"
        )
        self.collections.upload(results, id)
        return {"documents": results, "id": id}

    def create_document_data(self, doc, content, content_chunked) -> DocumentData:
        return {
            "cdtn_id": doc.cdtn_id,
            "initial_id": doc.initial_id,
            "title": doc.title,
            "content": content,
            "content_chunked": content_chunked,
            "url": BASE_URL_CDTN
            + "/"
            + self._get_path_from_collection_name(doc.source)
            + "/"
            + doc.slug,
            "source": doc.source,
        }

    def _get_path_from_collection_name(self, collection_name: CollectionName) -> str:
        mapping = {
            "code_du_travail": "code-du-travail",
            "fiches_service_public": "fiche-service-public",
            "page_fiche_ministere_travail": "fiche-ministere-travail",
            "information": "information",
        }
        return mapping[collection_name]


class ArticlesCodeDuTravailExploiter(BaseDataExploiter):
    def get_content(self, doc: Document) -> FormattedTextContent:
        return doc.text


class FichesMTExploiter(BaseDataExploiter):
    def get_content(self, doc: Document) -> FormattedTextContent:
        return "".join(
            section.get("html", "") for section in doc.document.get("sections", [])
        )


class FichesSPExploiter(BaseDataExploiter):
    def get_content(self, doc: Document) -> FormattedTextContent:
        raw_data = doc.document.get("raw", "")
        if raw_data:
            if isinstance(raw_data, str):
                raw_data = json.loads(raw_data)
            xml_content = self._parse_xml(raw_data)
            return xml_content.strip()
        return ""

    def _parse_xml(self, xml_as_json: XML_AS_JSON) -> FormattedTextContent:
        xml_content = ""
        if isinstance(xml_as_json, dict):
            if xml_as_json.get("type") == "element":
                tag_name = xml_as_json.get("name")
                attributes = xml_as_json.get("attributes", {})
                children = xml_as_json.get("children", [])
                xml_content += f"<{tag_name}"
                for attr_name, attr_value in attributes.items():
                    xml_content += f' {attr_name}="{attr_value}"'
                xml_content += ">"
                for child in children:
                    xml_content += self._parse_xml(child)
                xml_content += f"</{tag_name}>"
            elif xml_as_json.get("type") == "text":
                xml_content += xml_as_json.get("text", "")
        elif isinstance(xml_as_json, list):
            for item in xml_as_json:
                xml_content += self._parse_xml(item)
        return xml_content


class PageInfosExploiter(BaseDataExploiter):
    def get_content(self, doc: Document) -> FormattedTextContent:
        markdown = ""
        for content in doc.document.get("contents", []):
            for block in content.get("blocks", []):
                if block.get("type") == "markdown":
                    markdown += block.get("markdown", "")
        return markdown
